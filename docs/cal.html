<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>涨跌幅计算器</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; min-height: 100vh; padding: 20px; }
    .calculator { max-width: 560px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,.08); overflow: hidden; }
    .header { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding: 20px; text-align: center; }
    .header h1 { font-size: 22px; font-weight: 600; }
    .content { padding: 20px; }
    .section { margin-bottom: 20px; }
    .section h3 { color:#333; margin-bottom: 10px; font-size:16px; font-weight:600; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display:block; margin-bottom: 6px; color:#555; font-weight:500; }
    .form-row { display:flex; gap:12px; align-items:flex-end; }
    .form-row .form-group { flex:1; margin-bottom:0; }
    input, select, button { width:100%; padding: 10px; border:2px solid #e1e5e9; border-radius:8px; font-size:14px; transition:border-color .2s; }
    input:focus, select:focus { outline:none; border-color:#667eea; }
    button { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border:none; cursor:pointer; font-weight:500; transition:transform .2s; }
    button:hover { transform: translateY(-1px); }
    button:disabled { background:#ccc; cursor:not-allowed; transform:none; }
    .price-info { background:#f8f9fa; padding:14px; border-radius:8px; margin-bottom:14px; }
    .price-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .price-item { display:flex; justify-content:space-between; }
    .price-item strong { color:#333; }
    .positive { color:#22c55e; font-weight:600; }
    .negative { color:#ef4444; font-weight:600; }
    .neutral { color:#6b7280; font-weight:600; }
    .results { background:#f8f9fa; border-radius:8px; overflow:hidden; margin-top: 12px; }
    .results table { width:100%; border-collapse: collapse; }
    .results th, .results td { padding: 10px; text-align:left; border-bottom:1px solid #e1e5e9; }
    .results th { background:#e5e7eb; font-weight:600; color:#374151; }
    .results tr:last-child td { border-bottom:none; }
    .message { padding:10px; border-radius:8px; margin-bottom: 14px; font-weight:500; }
    .message.error { background:#fef2f2; color:#dc2626; border:1px solid #fecaca; }
    .message.success { background:#f0f9ff; color:#0369a1; border:1px solid #bae6fd; }
    .loading { color:#6b7280; font-style: italic; }
    @media (max-width: 600px) {
      .form-row { flex-direction: column; gap: 14px; }
      .content { padding: 16px; }
      body { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="calculator">
    <div class="header"><h1>涨跌幅计算器</h1></div>
    <div class="content">
      <!-- 基础设置 -->
      <div class="section">
        <h3>基础设置</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="precision">价格精度</label>
            <select id="precision">
              <option value="2" selected>2位小数</option>
              <option value="4">4位小数</option>
              <option value="6">6位小数</option>
              <option value="8">8位小数</option>
            </select>
          </div>
          <div class="form-group">
            <label for="symbol">币种</label>
            <input type="text" id="symbol" value="BTC-USDT" placeholder="如: BTC-USDT"/>
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button id="fetchPrice">获取开盘价 & 当前价格</button>
          </div>
        </div>
      </div>

      <!-- 消息提示 -->
      <div id="message" style="display:none;"></div>

      <!-- 价格信息 -->
      <div id="priceInfo" style="display:none;" class="price-info">
        <div class="price-grid">
          <div class="price-item"><span>开盘价:</span><strong id="openPrice">-</strong></div>
          <div class="price-item"><span>当前价:</span><strong id="currentPrice">-</strong></div>
          <div class="price-item"><span>最高价(当日):</span><strong id="highPrice">-</strong></div>
          <div class="price-item"><span>最低价(当日):</span><strong id="lowPrice">-</strong></div>
          <div class="price-item"><span>当日涨跌幅:</span><strong id="dailyChange">-</strong></div>
        </div>
      </div>

      <!-- 计算输入 -->
      <div class="section">
        <h3>持仓计算</h3>
        <div class="form-group">
          <label for="holdPrice">持仓价格</label>
          <input type="number" id="holdPrice" step="0.00000001" placeholder="输入您的持仓价格"/>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="targetPercent">期望幅度 (%)（相对持仓价）</label>
            <input type="number" id="targetPercent" step="0.01" placeholder="如: 5.50 或 -3.20"/>
          </div>
          <div class="form-group">
            <label for="targetPrice">期望点位（目标价格）</label>
            <input type="number" id="targetPrice" step="0.01" placeholder="目标价格"/>
          </div>
        </div>
        <div class="form-group">
          <label for="dailyExpectPercent">当日涨跌幅预期 (%)（相对开盘价）</label>
          <input type="number" id="dailyExpectPercent" step="0.01" placeholder="如: 2.50 或 -1.00"/>
        </div>
      </div>

      <!-- 计算结果 -->
      <div id="results" style="display:none;"></div>
    </div>
  </div>

  <script>
    class Calculator {
      constructor() {
        this.currentData = {
          openPrice: null,
          highPrice: null,
          lowPrice: null,
          currentPrice: null,
          symbol: 'BTC-USDT'
        };
        this.lastModified = null; // 'percent' | 'price' | 'daily'
        this.tickerInterval = null;
        this.init();
      }

      init() {
        this.bindEvents();
        this.fetchPriceData(); // 页面加载时自动获取 BTC-USDT
      }

      bindEvents() {
        // 精度变化：同步显示与输入步进
        document.getElementById('precision').addEventListener('change', () => {
          this.syncPrecisionSteps();
          this.updatePriceDisplay();
          // 同步期望点位展示精度
          this.syncTargetPricePrecision();
          this.calculate();
        });

        // 获取价格按钮
        document.getElementById('fetchPrice').addEventListener('click', () => {
          this.fetchPriceData();
        });

        // 持仓价输入
        document.getElementById('holdPrice').addEventListener('input', () => {
          // 如果有当日涨跌幅预期，持仓价变化时也实时联动
          if (document.getElementById('dailyExpectPercent').value.trim() !== '') {
            this.lastModified = 'daily';
            this.updateFromDailyExpect();
          }
          this.calculate();
        });

        // 期望幅度（相对持仓）
        document.getElementById('targetPercent').addEventListener('input', () => {
          this.lastModified = 'percent';
          this.updateTargetPriceFromPercent();
          this.updateDailyExpectFromTarget(); // 反推当日预期（若有开盘价）
          this.calculate();
        });

        // 期望点位（目标价格）
        document.getElementById('targetPrice').addEventListener('input', () => {
          this.lastModified = 'price';
          this.updateTargetPercentFromPrice();
          this.updateDailyExpectFromTarget(); // 反推当日预期（若有开盘价）
          this.calculate();
        });

        // 当日涨跌幅预期（相对开盘）
        document.getElementById('dailyExpectPercent').addEventListener('input', () => {
          this.lastModified = 'daily';
          this.updateFromDailyExpect();
          this.calculate();
        });

        // 币种输入回车获取价格
        document.getElementById('symbol').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.fetchPriceData();
        });

        // 初始同步输入步进
        this.syncPrecisionSteps();
      }

      // 步进同步：期望点位与价格显示精度一致
      syncPrecisionSteps() {
        const precision = parseInt(document.getElementById('precision').value);
        const stepStr = (1 / Math.pow(10, precision)).toFixed(precision);
        const targetPriceEl = document.getElementById('targetPrice');
        targetPriceEl.step = stepStr;
      }

      // 将期望点位值按当前精度重写显示
      syncTargetPricePrecision() {
        const precision = parseInt(document.getElementById('precision').value);
        const tp = parseFloat(document.getElementById('targetPrice').value);
        if (isFinite(tp)) {
          document.getElementById('targetPrice').value = tp.toFixed(precision);
        }
      }

      async fetchPriceData() {
        const symbol = document.getElementById('symbol').value.trim();
        if (!symbol) {
          this.showMessage('请输入币种', 'error');
          return;
        }
        this.showMessage('正在获取价格数据...', 'loading');
        document.getElementById('fetchPrice').disabled = true;

        try {
          // 获取 1D K 线（开盘价/最高/最低）
          const klineResp = await fetch(`https://www.okx.com/api/v5/market/candles?instId=${symbol}&bar=1D&limit=1`);
          const klineData = await klineResp.json();

          // 获取最新 ticker（当前价）
          const tickerResp = await fetch(`https://www.okx.com/api/v5/market/ticker?instId=${symbol}`);
          const tickerData = await tickerResp.json();

          if (klineData.code !== '0' || tickerData.code !== '0' || !klineData.data?.length || !tickerData.data?.length) {
            throw new Error('获取价格数据失败，请检查币种格式或稍后重试');
          }

          const k = klineData.data[0];
          const openPrice = parseFloat(k[1]); // 开盘
          const highPrice = parseFloat(k[2]); // 当日高
          const lowPrice  = parseFloat(k[3]); // 当日低
          const currentPrice = parseFloat(tickerData.data[0].last);

          this.currentData = { openPrice, highPrice, lowPrice, currentPrice, symbol };

          this.updatePriceDisplay();
          this.syncTargetPricePrecision();
          this.calculate();
          this.showMessage('价格数据获取成功', 'success');

          // 启动 10 秒自动刷新当前价
          this.startTickerAutoUpdate();

        } catch (err) {
          console.error(err);
          this.showMessage(err.message || 'API调用失败，请检查网络或币种格式', 'error');
          this.currentData = { openPrice: null, highPrice: null, lowPrice: null, currentPrice: null, symbol };
          this.updatePriceDisplay();
        } finally {
          document.getElementById('fetchPrice').disabled = false;
        }
      }

      startTickerAutoUpdate() {
        // 清理旧定时器
        if (this.tickerInterval) clearInterval(this.tickerInterval);
        const symbol = this.currentData.symbol;
        // 每 10 秒刷新当前价格
        this.tickerInterval = setInterval(async () => {
          try {
            const resp = await fetch(`https://www.okx.com/api/v5/market/ticker?instId=${symbol}`);
            const data = await resp.json();
            if (data.code === '0' && data.data?.length) {
              const newPrice = parseFloat(data.data[0].last);
              this.currentData.currentPrice = newPrice;
              this.updatePriceDisplay();
              this.calculate();
            }
          } catch (e) {
            console.warn('实时价格刷新失败：', e);
          }
        }, 10000);
      }

      updatePriceDisplay() {
        const priceInfo = document.getElementById('priceInfo');
        const { openPrice, highPrice, lowPrice, currentPrice } = this.currentData;
        const precision = parseInt(document.getElementById('precision').value);

        if (isFinite(openPrice) && isFinite(currentPrice)) {
          const dailyChangePercent = ((currentPrice - openPrice) / openPrice) * 100;

          document.getElementById('openPrice').textContent   = openPrice.toFixed(precision);
          document.getElementById('currentPrice').textContent = currentPrice.toFixed(precision);

          if (isFinite(highPrice)) document.getElementById('highPrice').textContent = highPrice.toFixed(precision);
          if (isFinite(lowPrice))  document.getElementById('lowPrice').textContent  = lowPrice.toFixed(precision);

          const dailyEl = document.getElementById('dailyChange');
          dailyEl.textContent = `${dailyChangePercent >= 0 ? '+' : ''}${dailyChangePercent.toFixed(2)}%`;
          dailyEl.className = dailyChangePercent >= 0 ? 'positive' : 'negative';

          priceInfo.style.display = 'block';
        } else {
          priceInfo.style.display = 'none';
        }
      }

      // 从期望幅度推期望点位（相对持仓）
      updateTargetPriceFromPercent() {
        const holdPrice = parseFloat(document.getElementById('holdPrice').value);
        const targetPercent = parseFloat(document.getElementById('targetPercent').value);
        const precision = parseInt(document.getElementById('precision').value);
        if (isFinite(holdPrice) && isFinite(targetPercent)) {
          const targetPrice = holdPrice * (1 + targetPercent / 100);
          document.getElementById('targetPrice').value = targetPrice.toFixed(precision);
        }
      }

      // 从期望点位推期望幅度（相对持仓）
      updateTargetPercentFromPrice() {
        const holdPrice = parseFloat(document.getElementById('holdPrice').value);
        const targetPrice = parseFloat(document.getElementById('targetPrice').value);
        if (isFinite(holdPrice) && isFinite(targetPrice) && holdPrice !== 0) {
          const targetPercent = ((targetPrice - holdPrice) / holdPrice) * 100;
          document.getElementById('targetPercent').value = targetPercent.toFixed(2);
        }
      }

      // 当日涨跌幅预期：基于开盘价计算目标价，并联动持仓幅度
      updateFromDailyExpect() {
        const openPrice = this.currentData.openPrice;
        const holdPrice = parseFloat(document.getElementById('holdPrice').value);
        const dailyExpect = parseFloat(document.getElementById('dailyExpectPercent').value);
        const precision = parseInt(document.getElementById('precision').value);
        if (!isFinite(openPrice)) return;

        if (isFinite(dailyExpect)) {
          const targetPrice = openPrice * (1 + dailyExpect / 100);
          document.getElementById('targetPrice').value = targetPrice.toFixed(precision);
          if (isFinite(holdPrice) && holdPrice !== 0) {
            const targetPercent = ((targetPrice - holdPrice) / holdPrice) * 100;
            document.getElementById('targetPercent').value = targetPercent.toFixed(2);
          }
        }
      }

      // 反推当日涨跌幅预期（当有开盘价与目标价时）
      updateDailyExpectFromTarget() {
        const openPrice = this.currentData.openPrice;
        const targetPrice = parseFloat(document.getElementById('targetPrice').value);
        if (!isFinite(openPrice) || !isFinite(targetPrice) || openPrice === 0) return;
        const dailyExpect = ((targetPrice - openPrice) / openPrice) * 100;
        document.getElementById('dailyExpectPercent').value = dailyExpect.toFixed(2);
      }

      calculate() {
        const holdPrice = parseFloat(document.getElementById('holdPrice').value);
        const { openPrice, currentPrice } = this.currentData;
        const precision = parseInt(document.getElementById('precision').value);

        if (!isFinite(currentPrice)) {
          this.showMessage('请先获取价格数据', 'error');
          document.getElementById('results').style.display = 'none';
          return;
        }
        if (!isFinite(holdPrice) || holdPrice <= 0) {
          this.showMessage('请输入有效的持仓价格', 'error');
          document.getElementById('results').style.display = 'none';
          return;
        }

        // 当前持仓盈亏（相对当前价）
        const currentPnL = ((currentPrice - holdPrice) / holdPrice) * 100;

        let results = `
          <table>
            <thead><tr><th>项目</th><th>数值</th></tr></thead>
            <tbody>
              <tr>
                <td>当前持仓盈亏</td>
                <td class="${currentPnL >= 0 ? 'positive' : 'negative'}">
                  ${currentPnL >= 0 ? '+' : ''}${currentPnL.toFixed(2)}%
                </td>
              </tr>
        `;

        // 期望值联动：按最后修改优先，其次使用可用字段推导
        const tpInput = parseFloat(document.getElementById('targetPrice').value);
        const tpctInput = parseFloat(document.getElementById('targetPercent').value);
        const dailyInput = parseFloat(document.getElementById('dailyExpectPercent').value);

        let finalTargetPrice = null;
        let finalTargetPercent = null;
        let targetVsOpen = null;

        const hasOpen = isFinite(openPrice);

        const computeFromDaily = () => {
          if (hasOpen && isFinite(dailyInput)) {
            finalTargetPrice = openPrice * (1 + dailyInput / 100);
            finalTargetPercent = ((finalTargetPrice - holdPrice) / holdPrice) * 100;
            targetVsOpen = dailyInput;
          }
        };
        const computeFromPercent = () => {
          if (isFinite(tpctInput)) {
            finalTargetPrice = holdPrice * (1 + tpctInput / 100);
            finalTargetPercent = tpctInput;
            if (hasOpen) targetVsOpen = ((finalTargetPrice - openPrice) / openPrice) * 100;
          }
        };
        const computeFromPrice = () => {
          if (isFinite(tpInput)) {
            finalTargetPrice = tpInput;
            finalTargetPercent = ((tpInput - holdPrice) / holdPrice) * 100;
            if (hasOpen) targetVsOpen = ((tpInput - openPrice) / openPrice) * 100;
          }
        };

        // 优先使用最后修改来源
        if (this.lastModified === 'daily') computeFromDaily();
        else if (this.lastModified === 'percent') computeFromPercent();
        else if (this.lastModified === 'price') computeFromPrice();
        // 若没有最后修改标记或对应数据缺失，回退尝试其他来源
        if (!isFinite(finalTargetPrice)) {
          if (isFinite(dailyInput) && hasOpen) computeFromDaily();
          else if (isFinite(tpInput)) computeFromPrice();
          else if (isFinite(tpctInput)) computeFromPercent();
        }

        if (isFinite(finalTargetPrice)) {
          results += `
            <tr>
              <td>目标价格</td>
              <td>${finalTargetPrice.toFixed(precision)}</td>
            </tr>
            <tr>
              <td>相对持仓价涨跌幅</td>
              <td class="${finalTargetPercent >= 0 ? 'positive' : 'negative'}">
                ${finalTargetPercent >= 0 ? '+' : ''}${finalTargetPercent.toFixed(2)}%
              </td>
            </tr>
          `;
          if (hasOpen && isFinite(targetVsOpen)) {
            results += `
              <tr>
                <td>相对开盘价涨跌幅</td>
                <td class="${targetVsOpen >= 0 ? 'positive' : 'negative'}">
                  ${targetVsOpen >= 0 ? '+' : ''}${targetVsOpen.toFixed(2)}%
                </td>
              </tr>
            `;
          }
        }

        results += '</tbody></table>';
        document.getElementById('results').innerHTML = results;
        document.getElementById('results').style.display = 'block';
        this.hideMessage();
      }

      showMessage(text, type = 'error') {
        const messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
        messageEl.style.display = 'block';
      }
      hideMessage() { document.getElementById('message').style.display = 'none'; }
    }

    // 初始化计算器
    new Calculator();
  </script>
</body>
</html>